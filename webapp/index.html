<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>BeagleLogic</title>
	<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css">
	<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.css">
	<link rel="stylesheet" href="stylesheets/beaglelogic.css">	
</head>
<body>
	<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	  <div class="container-fluid">
		<div class="navbar-header">
		  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
			<span class="sr-only">Toggle navigation</span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
		  </button>
		  <a class="navbar-brand" href="#">BeagleLogic</a>
		  <p class="navbar-text">A logic analyzer on the BeagleBone Black</p>
		</div>
		<div class="navbar-collapse collapse">
		  <ul class="nav navbar-nav navbar-right">
		  	<li><a href="#" data-toggle="modal" data-target="#helpModal">Help</a></li>
				<li><a href="#" data-toggle="modal" data-target="#aboutModal">About</a></li>
		  </ul>
		</div>
	  </div>
	</div>
	<div class="container-fluid"><div class="row">
		<div class="col-sm-3 col-md-2 sidebar">
			<div id="menu"><div class="panel-group">
				<div class="panel panel-primary panel-default">
					<a href="#" class="panel-heading accordion-heading" data-toggle="collapse" data-target="#menu-config-1" data-parent="#menu"><span class="glyphicon glyphicon-cog"></span> Configuration</a>
					<div id="menu-config-1" class="panel-collapse collapse in"><div class="panel-body">
						<!-- Panel data here -->
						<div class="form-horizontal">
							<div class="form-group">
								<label for="samplerate" class="col-sm-5 control-label">Sample Rate</label>
								<div class="col-sm-7">
									<select id="samplerate" class="form-control">
										<option value="100000">100 kHz</option>
										<option value="200000">200 kHz</option>
										<option value="400000">400 kHz</option>
										<option value="500000">500 kHz</option>
										<option value="1000000" selected>1 MHz</option>
										<option value="2000000">2 MHz</option>
										<option value="3000000">3.03 MHz</option>
										<option value="4000000">4 MHz</option>
										<option value="5000000">5 MHz</option>
										<option value="10000000">10 MHz</option>
										<option value="20000000">20 MHz</option>
										<option value="25000000">25 MHz</option>
										<option value="50000000">50 MHz</option>
										<option value="100000000">100 MHz</option>
									</select>
								</div>
							</div>
							<div class="form-group">
								<label for="samplerate" class="col-sm-5 control-label">Sample Limit</label>
								<div class="col-sm-7">
									<input class="form-control" type="text" value="10000">
								</div>
							</div>
						</div>
					</div></div>
				</div>
				<div class="panel panel-primary panel-default">
					<a href="#" class="panel-heading accordion-heading" data-toggle="collapse" data-target="#menu-config-2" data-parent="#menu"><span class="glyphicon glyphicon-th-list"></span> Input Selection and Annotation</a>
					<div id="menu-config-2" class="panel-collapse collapse in"><div class="panel-body">
						<!-- Panel data here -->
							<div class="row pin-selector">
								<!-- Template for every two pins here -->
								<div style="float:left; width:50%"><fieldset disabled>
									<div class="input-group">
										<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_19">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" ></span>
									</div>
								</fieldset></div>
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_20"></span>
										<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_20">
									</div>
								</div>
							</div>
							<div class="row pin-selector">
								<!-- Template for every two pins here -->
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_21">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_43"></span>
									</div>
								</div>
								<div style="float:left; width:50%"><fieldset disabled>
									<div class="input-group">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
										<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_22">
									</div>
								</fieldset></div>
							</div>
							<fieldset disabled>
								<div class="row pin-selector">
									<!-- Template for every two pins here -->
									<div style="float:left; width:50%">
										<div class="input-group">
											<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_23">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
										</div>
									</div>
									<div style="float:left; width:50%">
										<div class="input-group">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
											<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_24">
										</div>
									</div>
								</div>
								<div class="row pin-selector">
									<!-- Template for every two pins here -->
									<div style="float:left; width:50%">
										<div class="input-group">
											<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_25">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
										</div>
									</div>
									<div style="float:left; width:50%">
										<div class="input-group">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
											<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_26">
										</div>
									</div>
								</div>
							</fieldset>
							<div class="row pin-selector">
								<!-- Template for every two pins here -->
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_27">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_27"></span>
									</div>
								</div>
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_28"></span>
										<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_28">
									</div>
								</div>
							</div>
							<div class="row pin-selector">
								<!-- Template for every two pins here -->
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_29">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_29"></span>
									</div>
								</div>
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_30"></span>
										<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_30">
									</div>
								</div>
							</div>
							<fieldset disabled>
								<div class="row pin-selector">
									<!-- Template for every two pins here -->
									<div style="float:left; width:50%">
										<div class="input-group">
											<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_31">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
										</div>
									</div>
									<div style="float:left; width:50%">
										<div class="input-group">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
											<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_32">
										</div>
									</div>
								</div>
								<div class="row pin-selector">
									<!-- Template for every two pins here -->
									<div style="float:left; width:50%">
										<div class="input-group">
											<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_33">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
										</div>
									</div>
									<div style="float:left; width:50%">
										<div class="input-group">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
											<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_34">
										</div>
									</div>
								</div>
								<div class="row pin-selector">
									<!-- Template for every two pins here -->
									<div style="float:left; width:50%">
										<div class="input-group">
											<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_35">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
										</div>
									</div>
									<div style="float:left; width:50%">
										<div class="input-group">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
											<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_36">
										</div>
									</div>
								</div>
								<div class="row pin-selector">
									<!-- Template for every two pins here -->
									<div style="float:left; width:50%">
										<div class="input-group">
											<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_37">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
										</div>
									</div>
									<div style="float:left; width:50%">
										<div class="input-group">
											<span class="input-group-addon pin-selector-checkbox"><input type="checkbox"></span>
											<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_38">
										</div>
									</div>
								</div>
							</fieldset>
							<div class="row pin-selector">
								<!-- Template for every two pins here -->
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_39">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_39"></span>
									</div>
								</div>
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_40"></span>
										<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_40">
									</div>
								</div>
							</div>
							<div class="row pin-selector">
								<!-- Template for every two pins here -->
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_41">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_41"></span>
									</div>
								</div>
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_42"></span>
										<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_42">
									</div>
								</div>
							</div>
							<div class="row pin-selector">
								<!-- Template for every two pins here -->
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_43">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_43" checked></span>
									</div>
								</div>
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_44" checked></span>
										<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_44">
									</div>
								</div>
							</div>
							<div class="row pin-selector">
								<!-- Template for every two pins here -->
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<input type="text" class="form-control input-sm pin-selector-input text-right" placeholder="P8_45">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_45" checked></span>
									</div>
								</div>
								<div style="float:left; width:50%">
									<div class="input-group pin-selectors">
										<span class="input-group-addon pin-selector-checkbox"><input type="checkbox" value="P8_46" checked></span>
										<input type="text" class="form-control input-sm pin-selector-input" placeholder="P8_46">
									</div>
								</div>
							</div>
					</div></div>
				</div>
			</div></div>
		</div>
		
		<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
			<!-- Placeholder for all the alert messages -->
			<div id="alerts" style="height: 52px;"></div>
			<p>
			<div class="btn-toolbar">
				<div class="btn-group">
				  <button type="button" class="btn btn-default" onclick="beginCapture()"><span class="glyphicon glyphicon-play"></span> Begin Capture</button>
				</div>
				<div class="btn-group">
				  <button type="button" class="btn btn-default" onclick="saveCapture()"><span class="glyphicon glyphicon-save"></span> Save Capture</button>
				</div>
				<div class="btn-group">
				  <button type="button" class="btn btn-default" onclick="dumpRawData()"><span class="glyphicon glyphicon-import"></span> Dump Raw Data</button>
				</div>
			</div>
			<p>
			<div id="waveform0" style="width:100%;height:100%; overflow: auto;"></div>
			<p>
			<pre id="debug" style="bottom: 10px">Debug output will be shown here.</pre>
		</div>
	</div></div>

<!-- About BeagleLogic Dialog Box -->
<div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="AboutBeagleLogic" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="AboutBeagleLogic">About BeagleLogic</h4>
      </div>
      <div class="modal-body">
      BeagleLogic is a logic analyzer on the BeagleBone Black.
      Visit <a href="http://www.beaglelogic.net" target="_blank">beaglelogic.net</a> for more information.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Help Dialog Box -->
<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="Help" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="Help">About BeagleLogic</h4>
      </div>
      <div class="modal-body">
				<p>Help content is under construction.
				<p>Thank you for your cooperation.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="socket.io/socket.io.js" type="text/javascript"></script>
<script src="lz4.min.js" type="text/javascript"></script>
<script src="bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>
<script src="bower_components/bootstrap/dist/js/bootstrap.js" type="text/javascript"></script>
<script src="bower_components/wavedrom/skins/default.js" type="text/javascript"></script>
<script src="bower_components/wavedrom/skins/narrow.js" type="text/javascript"></script>
<script src="bower_components/wavedrom/WaveDrom.js" type="text/javascript"></script>
<script src="bower_components/q/q.js" type="text/javascript"></script>
<script src="bower_components/lls/dist/LargeLocalStorage.js" type="text/javascript"></script>
<script type="text/javascript">
	var socket = io();
	
	// Appends an alert into the alerts placeholder
	function showAlert(type, text) {
		$('#alerts').append(
				'<div class="alert alert-' + type + ' alert-dismissible" role="alert">' +
				'<button type="button" class="close" data-dismiss="alert">' +
				'<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>' +
				'</button>' + text + '</div>');
	}
	
	function renderWave(waveJSON) {		
		WaveDrom.RenderWaveForm(0, waveJSON, 'waveform');
		t = new Date() - t;
		$(".alert").alert('close');
		showAlert('info', 'Rendered in ' + t + ' ms');
	}

	var buf_size = 64 * 1024 * 1024;
	var storage = new LargeLocalStorage({ name: 'BeagleLogic', size: buf_size });
	
	storage.initialized.then(function(capacity) {
		console.log('Storage Granted');
	});

	function beginCapture() {
		socket.emit('sigrok-test');
		storage.setAttachment('beaglelogic-data', 'blob', null).then(function() {
			console.log('Attachment reset successfully');
		});
		$('#debug').html('');
	}

	function processOutput(data) {
		// Split into lines
		lines = data.split('\n');
		
		storage.setAttachment('beaglelogic-data', 'blob', data);
		
		// Create a default JSON and fill it with the data received over the socket
		var waveJSON = {
			signal: [
			  {name:'', wave:'' },
			{},
			  {name:'', wave: '' },
			{},
			  {name:'', wave:'' }
			],
			config: { skin: 'narrow' }
		};

		// sigrok-cli returns in this format
		// ..../""""""\......    """"\.....
		//                    ||
		// 0...1......0......    1...0.....
		// ^ Equivalent WaveDrom representation
		//
		// sr -> WaveDrom
		// .. -> ..
		// "" -> .. (same)
		// /  -> 1
		// \  -> 0
		
		n = lines.length - 4;
		for (i = 0; i < n; i++) {
			wave = lines[i + 2];
			
			sep = wave.split(':');
			id = sep[0];
			lanes = sep[1];

			// The first literal of the wave determines whether this is a '0' or a '1'
			if (lanes[0] == '.')
				lane = '0' + lanes.substring(1);
			else if (lanes[1] == '\"')
				lane = '1' + lanes.substring(1);
			
			// Perform the literal substitutions
			wave = lane.replace(/\"/g, '.').replace(/\\/g, '0').replace(/\//g, '1');
			
			// Insert into the schema
			waveJSON.signal[i * 2].name = id;
			waveJSON.signal[i * 2].wave = wave;
			
			$('#debug').append(id + ':' + wave + '\n');
		}

		// Render it
		renderWave(waveJSON);
	}

	socket.on('sigrok-data', function(data) {
		console.log('Received data', data.length);

		$('#debug').text(data);
		$('#debug').append('\nConverted to WaveDrom format:\n');

		setTimeout(processOutput(data), 0);
	});

	function saveCapture() {
	
	}

	function dumpRawData() {
	
	}

	socket.on('connect', function(data) {
		$(".alert").alert('close');
		showAlert('success', 'Connected to your BeagleBone');
	});

	socket.on('disconnect', function() {
		$(".alert").alert('close');
		showAlert('danger', 'Disconnected');
	});

	socket.on('sigrok-data-receive', function(data) {
		$(".alert").alert('close');
		$('#output').html('Data received: <br>' + data);	
	});

</script>
</body>
</html>